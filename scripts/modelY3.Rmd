# Model 3

Prediction model for `Y3`.

Train model over the tuning parameters.

```{r Y3Training, fig.show = "hide"}
cl <- makeCluster(8)
registerDoParallel(cl)
trainingModel <-
  dfTrainPreProc %>% 
  select(-c(id, Y1, Y2)) %>% 
  train(Y3 ~ .,
        data = .,
        method = method,
        trControl = ctrl,
        tuneGrid = grid,
        tuneLength = 10,
        nthreads = 8,
        na.action = "na.omit",
        importance = TRUE)
stopCluster(cl)
trainingModel
trainingModel %>% 
  ggplot() + 
  geom_line() +
  geom_point() +
  theme_bw()
ggsave("figures/Y3Training.png")
ggsave("figures/Y3Training.svg")
save(trainingModel, file = "output/Y3Training.RData")
# load("output/Y3Training.RData")
```

![figures/Y3Training.png](figures/Y3Training.png)

```{r Y3Training-predict}
trainingModel$finalModel
varImp(trainingModel)
dfTrainPred <- 
  dfTrainPreProc %>% 
  mutate(hat = predict(trainingModel, dfTrainPreProc) %>% as.numeric())
postResample(pred = dfTrainPred$hat, obs = dfTrainPred$Y3)
cor(dfTrainPred %>% select(Y3, hat))
dfTrainPred %>% 
  ggplot() +
  ggtitle(sprintf("Correlation = %.03f", cor(dfTrainPred %>% select(Y3, hat)) %>% .[1, 2])) +
  aes(x = hat, y = Y3) +
  geom_abline(slope = 1, intercept = 0) +
  geom_smooth(method = "lm", formula = y ~ x - 1, se = FALSE) +
  geom_smooth(method = "lm", formula = y ~ x, color = "red", se = FALSE) +
  geom_point(alpha = 1/2)
```

Evaluate model on the validation sample.

```{r Y3Validation-predict}
dfValidPred <- 
  dfValid %>% 
  select(-c(id, Y1, Y2)) %>% 
  select(-one_of(nzv$varname)) %>%
  filter(complete.cases(.)) %>% 
  predict(preProc, .) %>% 
  mutate(hat = predict(trainingModel, .) %>% as.numeric())
postResample(pred = dfValidPred$hat, obs = dfValidPred$Y3)
cor(dfValidPred %>% select(Y3, hat))
dfValidPred %>% 
  ggplot() +
  ggtitle(sprintf("Correlation = %.03f", cor(dfValidPred %>% select(Y3, hat)) %>% .[1, 2])) +
  aes(x = hat, y = Y3) +
  geom_abline(slope = 1, intercept = 0) +
  geom_smooth(method = "lm", formula = y ~ x - 1, se = FALSE) +
  geom_smooth(method = "lm", formula = y ~ x, color = "red", se = FALSE) +
  geom_point(alpha = 1/2)
```
