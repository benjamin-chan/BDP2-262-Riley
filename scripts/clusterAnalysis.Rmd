# Cluster analysis

Use divisive hierarchical clustering (DIANA).
See [Divisive Hierarchical Clustering Essentials](http://www.sthda.com/english/articles/28-hierarchical-clustering-essentials/94-divisive-hierarchical-clustering-essentials/).

```{r}
library(cluster)
library(factoextra)
citation("factoextra")
# library(ggdendro)
# library(dendextend)
# library(NbClust)
pal <- lacroix_palette("PommeBaya", type = "discrete")
```

```{r}
metric <- "manhattan"
plotClusters <- function (df, title = "Cluster plot") {
  require(magrittr)
  require(ggplot2)
  require(factoextra)
  df %>% 
  fviz_cluster(data = mat, 
               palette = sprintf("%s7F", pal[1:k]), 
               geom = c("points"),
               labelsize = 8, 
               ellipse.type = "convex",
               star.plot = TRUE) + 
  ggtitle(title) +
  theme(panel.grid.minor = element_blank())
}
hcDIANA <- function(k) {
  hcut <-
    dist %>% 
    hcut(k = k, hc_func = "diana", hc_metric = metric)
  tab <- hcut$cluster %>% table()
  dend <- 
    hcut %>% 
    fviz_dend(k = k, 
              type = "circular",
              rect = TRUE, 
              rect_fill = TRUE,
              cex = 0.25, 
              k_colors = pal[1:k], 
              main = sprintf("DIANA\nk = %d", k))
  clust <- hcut %>% plotClusters(sprintf("DIANA\nDivisive coefficient = %.03f\nk = %d", diana$dc, k))
  silh <- 
    hcut %>% 
    fviz_silhouette(palette = sprintf("%s3F", pal[1:k]), ggtheme = theme_minimal()) + 
    theme(panel.grid.major.x = element_blank()) +
    ggtitle(sprintf("DIANA\nk = %d\nAverage silhouette width = %.03f\nCluster average silhouette widths = %s",
                    k,
                    hcut[["silinfo"]][["avg.width"]],
                    hcut[["silinfo"]][["clus.avg.widths"]] %>% round(3) %>% paste(collapse = ", ")))
  list(hcut = hcut,
       table = tab,
       dendrogram = dend,
       clusters2d = clust,
       silhouette = silh)
}
```

Use the **`r metric`** metric.

```{r}
# load("data/processed/dataframes.RData")
dfNonMissing <- 
  df %>% 
  na.omit()
dfXMetrics <- 
  dfNonMissing %>% 
  select(matches("ECBI|MAPS|SEPTI")) %>% 
  droplevels()
dfXParentChild <- 
  dfNonMissing %>% 
  select(matches("parent|child|birth", ignore.case = TRUE)) %>% 
  droplevels()
dfXParent <- 
  dfNonMissing %>% 
  select(matches("^parent|^total", ignore.case = TRUE)) %>% 
  droplevels()
dfXChild <- 
  dfNonMissing %>% 
  select(matches("^child|^birth", ignore.case = TRUE)) %>% 
  droplevels()
dfXDemog <- 
  dfNonMissing %>% 
  select(matches("lang|zip|community|distance|income|internet")) %>% 
  select(-matches("lang")) %>% 
  droplevels()
dfYPCB <- 
  dfNonMissing %>% 
  select(starts_with("PCB"))
```


## Cluster on PCB metrics

**Clustering on PCB metrics isn't terrible.**

* Cluster 1 ($n = 253$) has high PCB scores on all domains
* Cluster 2 ($n = 4925$) has low PCB scores on all domains

```{r clusterYPCB}
mat <- model.matrix(~ - 1 + ., data = dfYPCB) %>% scale()
dist <- mat %>% dist(method = metric)
dim(mat)
colnames(mat)
hopkins <- get_clust_tendency(mat, n = nrow(mat) - 1, graph = FALSE)
diana <- dist %>% diana(metric = metric)
k <- 2
dianaYPCB <- hcDIANA(k)
dianaYPCB[["dendrogram"]]
dianaYPCB[["clusters2d"]]
dianaYPCB[["silhouette"]]
```

* Hopkins statistic is `r sprintf("%.03f", hopkins$hopkins_stat)`
* Analysis identified $k = `r k`$ clusters
* Divisive coefficient is `r sprintf("%.03f", diana$dc)`
* Average silhouette width is `r sprintf("%.03f", dianaYPCB[["hcut"]][["silinfo"]][["avg.width"]])`

```{r}
bind_cols(dfYPCB, 
          data.frame(cluster = dianaYPCB[["hcut"]][["cluster"]] %>% factor())) %>%
  group_by(cluster) %>%
  summarize(n = n(),
            PCB1_Total_mean      = mean(PCB1_Total),
            PCB1_CondEmot_mean   = mean(PCB1_CondEmot),
            PCB1_DevHab_mean     = mean(PCB1_DevHab)) %>% 
  kable(digits = 1)
bind_cols(dfYPCB, 
          data.frame(cluster = dianaYPCB[["hcut"]][["cluster"]] %>% factor())) %>%
  group_by(cluster) %>%
  summarize(n = n(),
            PCB2_Tot_mean        = mean(PCB2_Tot)) %>% 
  kable(digits = 1)
bind_cols(dfYPCB, 
          data.frame(cluster = dianaYPCB[["hcut"]][["cluster"]] %>% factor())) %>%
  group_by(cluster) %>%
  summarize(n = n(),
            PCB3_Total_mean      = mean(PCB3_Total),
            PCB3_PCPonly_mean    = mean(PCB3_PCPonly),
            PCB3_Person_mean     = mean(PCB3_Person),
            PCB3_Resource_mean   = mean(PCB3_Resource)) %>% 
  kable(digits = 1)
```


## Cluster on ECBI, MAPS, SEPTI metrics

**Clustering on ECBI, MAPS, and SEPTI metrics isn't terrible.**

* Cluster 1 ($n = 297$) has high positive MAPS scores and high SEPTI scores
* Cluster 2 ($n = 45$) has high negative MAPS scores and high ECBI scores
* Cluster 3 ($n = 3$) has low ECBI scores

```{r clusterXMetrics}
mat <- model.matrix(~ - 1 + ., data = dfXMetrics) %>% scale()
dist <- mat %>% dist(method = metric)
dim(mat)
colnames(mat)
hopkins <- get_clust_tendency(mat, n = nrow(mat) - 1, graph = FALSE)
diana <- dist %>% diana(metric = metric)
k <- 3
dianaXMetrics <- hcDIANA(k)
dianaXMetrics[["dendrogram"]]
dianaXMetrics[["clusters2d"]]
dianaXMetrics[["silhouette"]]
```

* Hopkins statistic is `r sprintf("%.03f", hopkins$hopkins_stat)`
* Analysis identified $k = `r k`$ clusters
* Divisive coefficient is `r sprintf("%.03f", diana$dc)`
* Average silhouette width is `r sprintf("%.03f", dianaXMetrics[["hcut"]][["silinfo"]][["avg.width"]])`

```{r}
bind_cols(dfXMetrics, 
          data.frame(cluster = dianaXMetrics[["hcut"]][["cluster"]] %>% factor())) %>%
  group_by(cluster) %>%
  summarize(n = n(),
            ECBI_intensity_T_score_mean = mean(ECBI_intensity_T_score),
            ECBI_problem_T_score_mean   = mean(ECBI_problem_T_score),
            ECBI_Opp_mean               = mean(ECBI_Opp),
            ECBI_Inatt_mean             = mean(ECBI_Inatt),
            ECBI_Cond_mean              = mean(ECBI_Cond)) %>%
  kable(digits = 1)
bind_cols(dfXMetrics, 
          data.frame(cluster = dianaXMetrics[["hcut"]][["cluster"]] %>% factor())) %>%
  group_by(cluster) %>%
  summarize(n = n(),
            MAPS_PP_mean  = mean(MAPS_PP),
            MAPS_PR_mean  = mean(MAPS_PR),
            MAPS_WM_mean  = mean(MAPS_WM),
            MAPS_SP_mean  = mean(MAPS_SP),
            MAPS_HS_mean  = mean(MAPS_HS),
            MAPS_LC_mean  = mean(MAPS_LC),
            MAPS_PC_mean  = mean(MAPS_PC),
            MAPS_POS_mean = mean(MAPS_POS),
            MAPS_NEG_mean = mean(MAPS_NEG)) %>%
  kable(digits = 1)
bind_cols(dfXMetrics, 
          data.frame(cluster = dianaXMetrics[["hcut"]][["cluster"]] %>% factor())) %>%
  group_by(cluster) %>%
  summarize(n = n(),
            SEPTI_nurturance_mean = mean(SEPTI_nurturance),
            SEPTI_discipline_mean = mean(SEPTI_discipline),
            SEPTI_play_mean       = mean(SEPTI_play),
            SEPTI_routine_mean    = mean(SEPTI_routine)) %>%
  kable(digits = 1)
```


## Cluster on parent factors

**Clustering on parent factors is terrible.**
First split, with $k = 2$, produces one very small cluster.

```{r clusterXParent}
mat <- model.matrix(~ - 1 + ., data = dfXParent) %>% scale()
dist <- mat %>% dist(method = metric)
dim(mat)
colnames(mat)
hopkins <- get_clust_tendency(mat, n = nrow(mat) - 1, graph = FALSE)
diana <- dist %>% diana(metric = metric)
k <- 2
dianaXParent <- hcDIANA(k)
dianaXParent[["dendrogram"]]
dianaXParent[["clusters2d"]]
dianaXParent[["silhouette"]]
```

* Hopkins statistic is `r sprintf("%.03f", hopkins$hopkins_stat)`
* Analysis identified $k = `r k`$ clusters
* Divisive coefficient is `r sprintf("%.03f", diana$dc)`
* Average silhouette width is `r sprintf("%.03f", dianaXParent[["hcut"]][["silinfo"]][["avg.width"]])`


```{r}
bind_cols(dfXParent, 
          data.frame(cluster = dianaXParent[["hcut"]][["cluster"]] %>% factor())) %>%
  group_by(cluster) %>%
  summarize(n = n(),
            totalChildren_mean = mean(totalChildren),
            totalChildren_median = median(totalChildren),
            parentAge_mean = mean(parentAge),
            parentAge_median = median(parentAge)) %>% 
  kable(digits = 1)
bind_cols(dfXParent, 
          data.frame(cluster = dianaXParent[["hcut"]][["cluster"]] %>% factor())) %>%
  group_by(cluster, parentGender) %>%
  summarize(n = n()) %>% 
  mutate(pct = n / sum(n)) %>% 
  kable(digits = 2)
bind_cols(dfXParent, 
          data.frame(cluster = dianaXParent[["hcut"]][["cluster"]] %>% factor())) %>%
  group_by(cluster, parentSituation) %>%
  summarize(n = n()) %>% 
  mutate(pct = n / sum(n)) %>% 
  kable(digits = 2)
bind_cols(dfXParent, 
          data.frame(cluster = dianaXParent[["hcut"]][["cluster"]] %>% factor())) %>%
  group_by(cluster, parentEducation) %>%
  summarize(n = n()) %>% 
  mutate(pct = n / sum(n)) %>% 
  kable(digits = 2)
bind_cols(dfXParent, 
          data.frame(cluster = dianaXParent[["hcut"]][["cluster"]] %>% factor())) %>%
  group_by(cluster, parentEthnicity) %>%
  summarize(n = n()) %>% 
  mutate(pct = n / sum(n)) %>% 
  kable(digits = 2)
bind_cols(dfXParent, 
          data.frame(cluster = dianaXParent[["hcut"]][["cluster"]] %>% factor())) %>%
  group_by(cluster, parentRaceWhite) %>%
  summarize(n = n()) %>% 
  mutate(pct = n / sum(n)) %>% 
  kable(digits = 2)
```


## Cluster on child factors

**Clustering on child factors is terrible.**
First split, with $k = 2$, produces one very small cluster.

```{r clusterXChild}
mat <- model.matrix(~ - 1 + ., data = dfXChild) %>% scale()
dist <- mat %>% dist(method = metric)
dim(mat)
colnames(mat)
hopkins <- get_clust_tendency(mat, n = nrow(mat) - 1, graph = FALSE)
diana <- dist %>% diana(metric = metric)
k <- 2
dianaXChild <- hcDIANA(k)
dianaXChild[["dendrogram"]]
dianaXChild[["clusters2d"]]
dianaXChild[["silhouette"]]
```

* Hopkins statistic is `r sprintf("%.03f", hopkins$hopkins_stat)`
* Analysis identified $k = `r k`$ clusters
* Divisive coefficient is `r sprintf("%.03f", diana$dc)`
* Average silhouette width is `r sprintf("%.03f", dianaXChild[["hcut"]][["silinfo"]][["avg.width"]])`


```{r}
bind_cols(dfXChild, 
          data.frame(cluster = dianaXChild[["hcut"]][["cluster"]] %>% factor())) %>%
  group_by(cluster) %>%
  summarize(n = n(),
            childAge_mean = mean(childAge),
            childAge_median = median(childAge)) %>% 
  kable(digits = 1)
bind_cols(dfXChild, 
          data.frame(cluster = dianaXChild[["hcut"]][["cluster"]] %>% factor())) %>%
  group_by(cluster, birthOrder) %>%
  summarize(n = n()) %>% 
  mutate(pct = n / sum(n)) %>% 
  kable(digits = 2)
bind_cols(dfXChild, 
          data.frame(cluster = dianaXChild[["hcut"]][["cluster"]] %>% factor())) %>%
  group_by(cluster, childSex) %>%
  summarize(n = n()) %>% 
  mutate(pct = n / sum(n)) %>% 
  kable(digits = 2)
bind_cols(dfXChild, 
          data.frame(cluster = dianaXChild[["hcut"]][["cluster"]] %>% factor())) %>%
  group_by(cluster, childEthnicity) %>%
  summarize(n = n()) %>% 
  mutate(pct = n / sum(n)) %>% 
  kable(digits = 2)
bind_cols(dfXChild, 
          data.frame(cluster = dianaXChild[["hcut"]][["cluster"]] %>% factor())) %>%
  group_by(cluster, childRaceWhite) %>%
  summarize(n = n()) %>% 
  mutate(pct = n / sum(n)) %>% 
  kable(digits = 2)
bind_cols(dfXChild, 
          data.frame(cluster = dianaXChild[["hcut"]][["cluster"]] %>% factor())) %>%
  group_by(cluster, childRelationship) %>%
  summarize(n = n()) %>% 
  mutate(pct = n / sum(n)) %>% 
  kable(digits = 2)
```


## Cluster on demographic factors

**Clustering on demographic factors is terrible.**
First two splits, with $k = 3$, produces two very small cluster.
The next split, at $k = 4$, produces a good sized cluster.

```{r clusterXDemog}
mat <- model.matrix(~ - 1 + ., data = dfXDemog) %>% scale()
dist <- mat %>% dist(method = metric)
dim(mat)
colnames(mat)
hopkins <- get_clust_tendency(mat, n = nrow(mat) - 1, graph = FALSE)
diana <- dist %>% diana(metric = metric)
k <- 4
dianaXDemog <- hcDIANA(k)
dianaXDemog[["dendrogram"]]
dianaXDemog[["clusters2d"]]
dianaXDemog[["silhouette"]]
```

* Hopkins statistic is `r sprintf("%.03f", hopkins$hopkins_stat)`
* Analysis identified $k = `r k`$ clusters
* Divisive coefficient is `r sprintf("%.03f", diana$dc)`
* Average silhouette width is `r sprintf("%.03f", dianaXDemog[["hcut"]][["silinfo"]][["avg.width"]])`

```{r}
bind_cols(dfXDemog, 
          data.frame(cluster = dianaXDemog[["hcut"]][["cluster"]] %>% factor())) %>%
  group_by(cluster) %>%
  summarize(n = n(),
         distance_mean = mean(distance),
         distance_median = median(distance)) %>% 
  kable(digits = 1)
bind_cols(dfXDemog, 
          data.frame(cluster = dianaXDemog[["hcut"]][["cluster"]] %>% factor())) %>%
  group_by(cluster, zipcodeClass) %>%
  summarize(n = n()) %>% 
  mutate(pct = n / sum(n)) %>% 
  kable(digits = 2)
bind_cols(dfXDemog, 
          data.frame(cluster = dianaXDemog[["hcut"]][["cluster"]] %>% factor())) %>%
  group_by(cluster, community) %>%
  summarize(n = n()) %>% 
  mutate(pct = n / sum(n)) %>% 
  kable(digits = 2)
bind_cols(dfXDemog, 
          data.frame(cluster = dianaXDemog[["hcut"]][["cluster"]] %>% factor())) %>%
  group_by(cluster, income) %>%
  summarize(n = n()) %>% 
  mutate(pct = n / sum(n)) %>% 
  kable(digits = 2)
bind_cols(dfXDemog, 
          data.frame(cluster = dianaXDemog[["hcut"]][["cluster"]] %>% factor())) %>%
  group_by(cluster, internet) %>%
  summarize(n = n()) %>% 
  mutate(pct = n / sum(n)) %>% 
  kable(digits = 2)
```


## Save objects

```{r}
f <- "data/processed/clusterAnalysis.RData"
save(dianaYPCB, dianaXMetrics, dianaXParentChild, dianaXDemog, file = f)
file.info(f)
```
