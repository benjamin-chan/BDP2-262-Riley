# Model 2

Prediction model for `Y2`.


## Data preprocessing

Split data set into 70:30 training:validation samples.

```{r, echo = TRUE}
inTrain <- createDataPartition(df$id, p = 0.7)
dfTrain <- df[inTrain$Resample1, ]
dfValid <- df[-inTrain$Resample1, ]
```

Preprocess the training sample.

1. Exclude near-zero variance predictors
2. Impute missing values using k-nearest neighbor

```{r, echo = TRUE}
message(sprintf("Number of complete cases before imputation = %d",
                complete.cases(dfTrain) %>% sum()))
nzv <- 
  dfTrain %>% 
  select(-c(id, Y1, Y2, Y3)) %>% 
  nearZeroVar(names = TRUE, saveMetric = TRUE) %>%
  mutate(varname = row.names(.)) %>% 
  filter(nzv == TRUE) %>% 
  select(varname, freqRatio, percentUnique, zeroVar, nzv) 
nzv %>% kable()
dfTrainPreProc1 <-
  dfTrain %>% 
  select(-one_of(nzv$varname)) %>% 
  select(-c(id, Y1, Y3))
preProc <-
  dfTrainPreProc1 %>% 
  preProcess(method = c("nzv", "corr", "knnImpute"), verbose = TRUE)
preProc
dfTrainPreProc2 <-  
  predict(preProc, dfTrainPreProc1) %>% 
  mutate(childAgeDichotomous = case_when(is.na(childAgeDichotomous) & childAge < 3 ~ 1,
                                         is.na(childAgeDichotomous) & childAge >= 3 ~ 2,
                                         TRUE ~ as.numeric(childAgeDichotomous))) %>% 
  mutate(childAgeDichotomous = factor(childAgeDichotomous, 
                                      levels = seq(2), 
                                      labels = c("Under 3", "3 or older")))
dfTrainPreProc <- dfTrainPreProc2
rm(dfTrainPreProc1, dfTrainPreProc2)
message(sprintf("Number of complete cases after imputation = %d",
                complete.cases(dfTrainPreProc) %>% sum()))
dfTrainPreProc %>% write.csv("data/processed/dfTrainPreProc.csv", row.names = FALSE)
```

## Training

Set the control parameters.

```{r, echo = TRUE}
ctrl <- trainControl(method = "repeatedcv",
                     number = 10,
                     repeats = 25,
                     savePredictions = TRUE,
                     allowParallel = TRUE,
                     search = "random")
```

Set the model and tuning parameter grid.

```{r, echo = TRUE}
library(randomForest)
method <- "rf"
grid <- expand.grid(mtry = seq(5, 10, 1))
```

Train model over the tuning parameters.

```{r Y2Training, fig.show = "hide"}
cl <- makeCluster(8)
registerDoParallel(cl)
trainingModel <-
  dfTrainPreProc %>% 
  train(Y2 ~ .,
        data = .,
        method = method,
        trControl = ctrl,
        tuneGrid = grid,
        tuneLength = 10,
        nthreads = 8,
        na.action = "na.omit",
        importance = TRUE)
stopCluster(cl)
trainingModel
trainingModel %>% 
  ggplot() + 
  geom_line() +
  geom_point() +
  theme_bw()
ggsave("figures/Y2Training.png")
ggsave("figures/Y2Training.svg")
save(trainingModel, file = "output/Y2Training.RData")
# load("output/Y2Training.RData")
```

![figures/Y2Training.png](figures/Y2Training.png)

```{r Y2Training-predict}
trainingModel$finalModel
varImp(trainingModel)
dfTrainPred <- 
  dfTrainPreProc %>% 
  mutate(hat = predict(trainingModel, dfTrainPreProc) %>% as.numeric())
postResample(pred = dfTrainPred$hat, obs = dfTrainPred$Y2)
cor(dfTrainPred %>% select(Y2, hat))
dfTrainPred %>% 
  ggplot() +
  ggtitle(sprintf("Correlation = %.03f", cor(dfTrainPred %>% select(Y2, hat)) %>% .[1, 2])) +
  aes(x = hat, y = Y2) +
  geom_abline(slope = 1, intercept = 0) +
  geom_smooth(method = "lm", formula = y ~ x - 1, se = FALSE) +
  geom_smooth(method = "lm", formula = y ~ x, color = "red", se = FALSE) +
  geom_point(alpha = 1/2)
```

Evaluate model on the validation sample.

```{r Y2Validation-predict}
dfValidPred <- 
  predict(preProc, dfValid) %>% 
  filter(complete.cases(.)) %>% 
  mutate(hat = predict(trainingModel, .) %>% as.numeric())
postResample(pred = dfValidPred$hat, obs = dfValidPred$Y2)
cor(dfValidPred %>% select(Y2, hat))
dfValidPred %>% 
  ggplot() +
  ggtitle(sprintf("Correlation = %.03f", cor(dfValidPred %>% select(Y2, hat)) %>% .[1, 2])) +
  aes(x = hat, y = Y2) +
  geom_abline(slope = 1, intercept = 0) +
  geom_smooth(method = "lm", formula = y ~ x - 1, se = FALSE) +
  geom_smooth(method = "lm", formula = y ~ x, color = "red", se = FALSE) +
  geom_point(alpha = 1/2)
```
