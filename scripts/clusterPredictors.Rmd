[https://uc-r.github.io/hc_clustering](https://uc-r.github.io/hc_clustering)
[http://www.sthda.com/english/wiki/factoextra-r-package-easy-multivariate-data-analyses-and-elegant-visualization](http://www.sthda.com/english/wiki/factoextra-r-package-easy-multivariate-data-analyses-and-elegant-visualization)

```{r}
library(cluster)
library(ggdendro)
library(factoextra)
library(dendextend)
```

```{r}
plotClusters <- function (df, title = "Cluster plot") {
  require(magrittr)
  require(ggplot2)
  require(factoextra)
  df %>% 
  fviz_cluster(data = mat, 
               palette = pal, 
               labelsize = 8, 
               ellipse.type = "none",
               star.plot = TRUE) + 
  ggtitle(title) +
  theme(panel.grid.minor = element_blank())
}
```

```{r}
load("data/processed/dataframes.RData")
dfX <- 
  df %>% 
  select(-id) %>% 
  select(-starts_with("PCB")) %>% 
  na.omit() %>% 
  droplevels()
mat <- 
  model.matrix(~ - 1 + ., data = dfX) %>% 
  scale()
dim(mat)
dfNonMissing <- 
  df %>% 
  na.omit()
```

```{r}
mat %>% fviz_nbclust(FUN = hcut, k.max = 30, method = "wss")
mat %>% fviz_nbclust(FUN = hcut, k.max = 10, method = "silhouette")
mat %>% fviz_nbclust(FUN = hcut, k.max = 10, method = "gap_stat", nboot = 50)
mat %>% get_dist(method = "euclidean") %>% fviz_dist()
mat %>% get_dist(method = "manhattan") %>% fviz_dist()
mat %>% get_dist(method = "maximum") %>% fviz_dist()
k <- 8
pal <- brewer.pal(k, "Set1")
# pal <- lacroix_palette("PommeBaya", type = "discrete")
```


## K-means clustering

```{r kmeans}
mat %>% fviz_nbclust(FUN = kmeans, k.max = 20, method = "wss")
k <- 2
km <- kmeans(mat, k)
km %>% .$cluster %>% table()
km %>% plotClusters("K-means clustering")
long <-
  km$centers %>% 
  data.frame() %>%
  mutate(cluster = 1:k) %>%
  gather(var, value, -cluster)
merge(long %>% filter(cluster == 1) %>% select(-cluster) %>% rename(cluster = value),
      long %>% filter(cluster == 2) %>% select(-cluster) %>% rename(cluster = value),
      by = c("var"),
      suffixes = c("1", "2")) %>%
  kable()
```


## Partitioning around medoids (PAM)

```{r pam}
mat %>% fviz_nbclust(FUN = cluster::pam, method = "silhouette")
k <- 2
pam <- pam(mat, k, metric = "euclidean", stand = FALSE)
pam %>% .$cluster %>% table()
pam %>% plotClusters("PAM")
long <-
  pam$medoids %>% 
  data.frame() %>%
  mutate(cluster = 1:k) %>%
  gather(var, value, -cluster)
merge(long %>% filter(cluster == 1) %>% select(-cluster) %>% rename(cluster = value),
      long %>% filter(cluster == 2) %>% select(-cluster) %>% rename(cluster = value),
      by = c("var"),
      suffixes = c("1", "2")) %>%
  kable()
```


## Hierarchical clustering

```{r hclust}
hclust <- 
  mat %>% 
  hcut(k = k, hc_func = "hclust", hc_method = "ward.D2", hc_metric = "manhattan")
hclust %>% .$cluster %>% table()
hclust %>% plotClusters("Hierarchical clustering")
hclust %>% fviz_dend(rect = TRUE, cex = 0.5, k_colors = pal)
hclust %>% fviz_silhouette(palette = pal, ggtheme = theme_minimal())
```


## Agglomerative hierarchical clustering (AGNES)

```{r agnes}
k <- 8
agnes <- 
  mat %>% 
  hcut(k = k, hc_func = "agnes", hc_method = "ward.D2", hc_metric = "manhattan")
ac <- sprintf("Agglomerative coefficient = %.03f (%s method)", agnes$ac, agnes$method)
ac %>% message()
agnes$cluster %>% table()
agnes %>% plotClusters(sprintf("AGNES\n%s", ac))
agnes %>% fviz_dend(rect = TRUE, cex = 0.5, k_colors = pal, main = ac)
agnes %>% fviz_silhouette(palette = pal, ggtheme = theme_minimal())
```


## Divisive hierarchical clustering (DIANA)

```{r diana}
k <- 6
diana <- 
  mat %>% 
  hcut(k = k, hc_func = "diana", hc_method = "ward.D2", hc_metric = "manhattan")
dc <- sprintf("Divisive coefficient = %.03f", diana$dc)
dc %>% message()
diana %>% .$cluster %>% table()
diana %>% plotClusters(sprintf("DIANA\n%s", dc))
diana %>% fviz_dend(rect = TRUE, cex = 0.5, k_colors = pal, main = dc)
diana %>% fviz_silhouette(palette = pal, ggtheme = theme_minimal())
```


## Compare

Comparison between `agnes` and `diana` doesn't give much insight.

```{r tanglegram}
dendlist(as.dendrogram(hcAgnes), as.dendrogram(hcDiana)) %>% 
  tanglegram(main_left = "Agnes",
             main_right = "Diana",
             common_subtrees_color_branches = TRUE)
```
