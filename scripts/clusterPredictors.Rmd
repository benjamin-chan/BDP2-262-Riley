[https://uc-r.github.io/hc_clustering](https://uc-r.github.io/hc_clustering)
[http://www.sthda.com/english/wiki/factoextra-r-package-easy-multivariate-data-analyses-and-elegant-visualization](http://www.sthda.com/english/wiki/factoextra-r-package-easy-multivariate-data-analyses-and-elegant-visualization)

```{r}
library(cluster)
library(ggdendro)
library(factoextra)
library(dendextend)
library(NbClust)
citation("factoextra")
# pal <- brewer.pal(9, "Set1")
pal <- lacroix_palette("PommeBaya", type = "discrete")
```

```{r}
plotClusters <- function (df, title = "Cluster plot") {
  require(magrittr)
  require(ggplot2)
  require(factoextra)
  df %>% 
  fviz_cluster(data = mat, 
               palette = sprintf("%s7F", pal), 
               geom = c("points"),
               labelsize = 8, 
               ellipse.type = "convex",
               star.plot = TRUE) + 
  ggtitle(title) +
  theme(panel.grid.minor = element_blank())
}
```

```{r}
# load("data/processed/dataframes.RData")
dfNonMissing <- 
  df %>% 
  na.omit()
dfX <- 
  dfNonMissing %>% 
  select(-id) %>% 
  select(-starts_with("PCB")) %>% 
  droplevels()
dfY <- 
  dfNonMissing %>% 
  select(starts_with("PCB"))
mat <- 
  model.matrix(~ - 1 + ., data = dfX) %>% 
  scale()
dist <- mat %>% dist(method = "manhattan")
dim(dfNonMissing)
dim(dfX)
dim(dfY)
dim(mat)
dim(dist)
```

```{r, eval = FALSE}
mat %>% fviz_nbclust(FUN = hcut, k.max = 30, method = "wss")
mat %>% fviz_nbclust(FUN = hcut, k.max = 10, method = "silhouette")
mat %>% fviz_nbclust(FUN = cluster::pam, k.max = 10, method = "gap_stat", nboot = 500)
mat %>% get_dist(method = "euclidean") %>% fviz_dist()
mat %>% get_dist(method = "manhattan") %>% fviz_dist()
mat %>% get_dist(method = "maximum") %>% fviz_dist()
```


## K-means clustering

```{r predictors_kmeans}
mat %>% fviz_nbclust(FUN = kmeans, method = "wss", k.max = 40)
mat %>% fviz_nbclust(FUN = kmeans, method = "silhouette")
mat %>% fviz_nbclust(FUN = kmeans, method = "gap_stat", k.max = 10, nboot = 500)
k <- 3
km <- kmeans(mat, k)
km %>% .$cluster %>% table()
km %>% plotClusters(sprintf("K-means clustering\nk = %d", k))
message(sprintf("Within cluster sum of squares, cluster %d: %.02f\n", 
                1:k, 
                km[["withinss"]]))
message(sprintf("Between SS / Total SS: %.02f / %.02f = %.02f%%", 
                km[["betweenss"]],
                km[["totss"]],
                km[["betweenss"]] / km[["totss"]] * 100))
message(sprintf("Total within SS: %.02f", km[["tot.withinss"]]))
km[["centers"]] %>% t() %>% kable(digits = 2)
```


## Partitioning around medoids (PAM)

```{r predictors_pam}
mat %>% fviz_nbclust(FUN = cluster::pam, method = "wss", k.max = 40)
mat %>% fviz_nbclust(FUN = cluster::pam, method = "silhouette")
mat %>% fviz_nbclust(FUN = cluster::pam, method = "gap_stat", k.max = 25, nboot = 500)
k <- 2
pam <- pam(mat, k, metric = "manhattan", stand = FALSE)
pam %>% .$cluster %>% table()
pam %>% plotClusters(sprintf("PAM\nk = %d", k))
pam[["clusinfo"]] %>% kable(digits = 2)
pam[["medoids"]] %>% t() %>% kable(digits = 2)
```


## Agglomerative hierarchical clustering (AGNES)

```{r predictors_agnes}
method1 <- "ward.D2"  # "complete"
method2 <- "ward"     # "complete"
hc <- hclust(d = dist, method = method1)
coph <- hc %>% cophenetic()
agnes <- dist %>% agnes(metric = "manhattan", method = method2)
agnes %>% fviz_dend(cex = 0.25, type = "circular", main = "AGNES")
```

Correlation between cophenetic distance and the original distance is
`r sprintf("%.03f", cor(dist, coph))`.

> The closer the value of the correlation coefficient is to 1, the more accurately the clustering solution reflects your data.
> Values above 0.75 are felt to be good.

Agglomerative coeffficient using the
`r sprintf("%s", tools::toTitleCase(agnes$method))`
method is
`r sprintf("%.03f", agnes$ac)`.

```{r}
foo <- function(k) {
  hcut <-
    dist %>% 
    hcut(k = k, hc_func = "agnes", hc_method = method1, hc_metric = "manhattan")
  tab <- hcut$cluster %>% table()
  dend <- 
    agnes %>% 
    fviz_dend(k = k, 
              type = "circular",
              rect = TRUE, 
              rect_fill = TRUE,
              cex = 0.25, 
              k_colors = pal[1:k], 
              main = sprintf("AGNES\nk = %d", k))
  clust <- hcut %>% plotClusters(sprintf("AGNES\nAgglomerative coefficient = %.03f\nk = %d", agnes$ac, k))
  silh <- 
    hcut %>% 
    fviz_silhouette(palette = sprintf("%s3F", pal[1:k]), ggtheme = theme_minimal()) + 
    theme(panel.grid.major.x = element_blank()) +
    ggtitle(sprintf("AGNES\nk = %d\nAverage silhouette width = %.03f\nCluster average silhouette widths = %s",
                    k,
                    hcut[["silinfo"]][["avg.width"]],
                    hcut[["silinfo"]][["clus.avg.widths"]] %>% round(3) %>% paste(collapse = ", ")))
  list(hcut = hcut,
       table = tab,
       dendrogram = dend,
       clusters2d = clust,
       silhouette = silh)
}
```

### $k = 2$ clusters

```{r predictors_agnes_k2}
k <- 2
agnes_k2 <- foo(k)
agnes_k2[["table"]]
agnes_k2[["dendrogram"]]
agnes_k2[["clusters2d"]]
agnes_k2[["silhouette"]]
```

### $k = 3$ clusters

```{r predictors_agnes_k3}
k <- 3
agnes_k3 <- foo(k)
agnes_k3[["table"]]
agnes_k3[["dendrogram"]]
agnes_k3[["clusters2d"]]
agnes_k3[["silhouette"]]
```

### $k = 4$ clusters

```{r predictors_agnes_k4}
k <- 4
agnes_k4 <- foo(k)
agnes_k4[["table"]]
agnes_k4[["dendrogram"]]
agnes_k4[["clusters2d"]]
agnes_k4[["silhouette"]]
```

### $k = 5$ clusters

```{r predictors_agnes_k5}
k <- 5
agnes_k5 <- foo(k)
agnes_k5[["table"]]
agnes_k5[["dendrogram"]]
agnes_k5[["clusters2d"]]
agnes_k5[["silhouette"]]
```


## Divisive hierarchical clustering (DIANA)

```{r predictors_diana}
diana <- dist %>% diana(metric = "manhattan")
diana %>% fviz_dend(cex = 0.25, type = "circular", main = "DIANA")
```

Divisive coefficient is
`r sprintf("%.03f", diana$dc)`.

```{r}
foo <- function(k) {
  hcut <-
    dist %>% 
    hcut(k = k, hc_func = "diana", hc_metric = "manhattan")
  tab <- hcut$cluster %>% table()
  dend <- 
    diana %>% 
    fviz_dend(k = k, 
              type = "circular",
              rect = TRUE, 
              rect_fill = TRUE,
              cex = 0.25, 
              k_colors = pal[1:k], 
              main = sprintf("DIANA\nk = %d", k))
  clust <- hcut %>% plotClusters(sprintf("DIANA\nDivisive coefficient = %.03f\nk = %d", diana$dc, k))
  silh <- 
    hcut %>% 
    fviz_silhouette(palette = sprintf("%s3F", pal[1:k]), ggtheme = theme_minimal()) + 
    theme(panel.grid.major.x = element_blank()) +
    ggtitle(sprintf("DIANA\nk = %d\nAverage silhouette width = %.03f\nCluster average silhouette widths = %s",
                    k,
                    hcut[["silinfo"]][["avg.width"]],
                    hcut[["silinfo"]][["clus.avg.widths"]] %>% round(3) %>% paste(collapse = ", ")))
  list(hcut = hcut,
       table = tab,
       dendrogram = dend,
       clusters2d = clust,
       silhouette = silh)
}
```

### $k = 2$ clusters

```{r predictors_diana_k2}
k <- 2
diana_k2 <- foo(k)
diana_k2[["table"]]
diana_k2[["dendrogram"]]
diana_k2[["clusters2d"]]
diana_k2[["silhouette"]]
```

### $k = 3$ clusters

```{r predictors_diana_k3}
k <- 3
diana_k3 <- foo(k)
diana_k3[["table"]]
diana_k3[["dendrogram"]]
diana_k3[["clusters2d"]]
diana_k3[["silhouette"]]
```

### $k = 4$ clusters

```{r predictors_diana_k4}
k <- 4
diana_k4 <- foo(k)
diana_k4[["table"]]
diana_k4[["dendrogram"]]
diana_k4[["clusters2d"]]
diana_k4[["silhouette"]]
```

### $k = 5$ clusters

```{r predictors_diana_k5}
k <- 5
diana_k5 <- foo(k)
diana_k5[["table"]]
diana_k5[["dendrogram"]]
diana_k5[["clusters2d"]]
diana_k5[["silhouette"]]
```


## Compare

Comparison between `agnes` and `diana` doesn't give much insight.

*Do not evaluate*

```{r predictors_tanglegram, eval = FALSE}
dendlist(as.dendrogram(agnes), as.dendrogram(diana)) %>% 
  tanglegram(main_left = "AGNES",
             main_right = "DIANA",
             common_subtrees_color_branches = TRUE)
```


## Final cluster identification

Use DIANA, $k = 2$

```{r predictors_final_clustering}
diana_k2[["table"]]
diana_k2[["dendrogram"]]
diana_k2[["clusters2d"]]
diana_k2[["silhouette"]]
save(diana_k2, file = "data/processed/predictor_clusters.RData")
```
