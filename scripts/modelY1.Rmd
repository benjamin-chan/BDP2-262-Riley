# Model 1

Prediction model for `Y1`.


## Data preprocessing

Split data set into 60:40 training:validation samples.

```{r}
inTrain <- createDataPartition(df$id, p = 0.7)
dfTrain <- df[inTrain$Resample1, ]
dfValid <- df[-inTrain$Resample1, ]
```

Preprocess the training sample.

1. Exclude near-zero variance predictors
2. Center variables
3. Scale variables
4. Impute missing values using k-nearest neighbor

```{r}
preProc <-
  dfTrain %>% 
  select(-c(id, Y1, Y2, Y3)) %>% 
  preProcess(method = c("nzv", "corr", "medianImpute"))
preProc
dfTrainPreProc <- predict(preProc, dfTrain)
dfTrainPreProc %>% write.csv("data/processed/dfTrainPreProc.csv", row.names = FALSE)
```

## Training

Set the control parameters.

```{r}
ctrl <- trainControl(method = "repeatedcv",
                     number = 10,
                     repeats = 10,
                     savePredictions = TRUE,
                     allowParallel = TRUE,
                     search = "random")
```

Set the model and tuning parameter grid.

```{r}
library(randomForest)
method <- "rf"
grid <- expand.grid(mtry = seq(2, 16, 2))
```

Fit model over the tuning parameters.

```{r trainingModel, fig.show = "hide"}
trainingModel <-
  dfTrainPreProc %>% 
  select(-c(id, Y2, Y3)) %>% 
  train(Y1 ~ .,
        data = .,
        method = method,
        trControl = ctrl,
        tuneGrid = grid,
        tuneLength = 10,
        nthreads = 8,
        na.action = "na.omit")
trainingModel
trainingModel %>% 
  ggplot() + 
  geom_line() +
  geom_point() +
  theme_bw()
ggsave("figures/trainingModel.png")
ggsave("figures/trainingModel.svg")
```

![figures/trainingModel.png](figures/trainingModel.png)

```{r, eval = FALSE}
hat <- predict(trainingModel, dfTrainPreProc)
varImp(trainingModel)
trainingModel$finalModel
```
